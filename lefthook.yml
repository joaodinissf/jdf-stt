# ============================================================================
# LEFTHOOK CONFIGURATION - PYTHON ONLY
# ============================================================================
# Fast local development Git hooks for the STT project (Python only)
#
# Prerequisites:
#   uv tool install pycln isort ruff pyright
#
# Usage:
#   lefthook install        # Install hooks
#   git commit              # Runs automatically
#   LEFTHOOK=0 git commit   # Skip hooks
# ============================================================================

pre-commit:
  jobs:
    # ========================================================================
    # GROUP 1: PYTHON FORMATTERS (SEQUENTIAL)
    # These must run in order: pycln → isort → ruff format
    # ========================================================================
    - group:
        parallel: false
        jobs:
          - name: pycln
            run: pycln --all {staged_files}
            glob: "*.py"
          - name: isort
            run: isort {staged_files}
            glob: "*.py"
          - name: ruff-format
            run: ruff format --force-exclude {staged_files}
            glob: "*.{py,pyi}"

    # ========================================================================
    # GROUP 2: PYTHON CHECKS (PARALLEL)
    # Read-only checks that can run concurrently
    # ========================================================================
    - group:
        parallel: true
        jobs:
          - name: ruff-check
            run: ruff check --force-exclude {staged_files}
            glob: "*.{py,pyi}"
          - name: pyright
            run: pyright {staged_files}
            glob: "*.py"

    # ========================================================================
    # GROUP 3: GENERAL FILE CHECKS
    # ========================================================================
    - group:
        parallel: true
        jobs:
          - name: trailing-whitespace
            run: sed -i '' -e 's/[[:space:]]*$//' {staged_files}
            glob: "*.{py,sh,yml,yaml,toml,md}"
          - name: detect-private-key
            run: |-
              for file in {all_files}; do
                if [ -f "$file" ] && [ "${file##*.}" != "yml" ] && [ "${file##*.}" != "yaml" ]; then
                  if grep -l "BEGIN.*PRIVATE KEY" "$file" 2>/dev/null; then
                    echo "Error: Private key detected in $file!"
                    exit 1
                  fi
                fi
              done
            glob: "*"
